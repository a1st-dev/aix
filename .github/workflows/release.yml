name: Release Packages

on:
   push:
      tags:
         - 'v*'

jobs:
   test:
      name: Test before release (Node ${{ matrix.node }}, ${{ matrix.os }})
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest, windows-latest]
            node: [lts/*, 22]
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v6
           with:
              node-version: ${{ matrix.node }}
              cache: npm

         - name: Install dependencies
           run: npm ci

         - name: Run standards
           run: npm run standards

         - name: Run tests
           run: npm test

         - name: Build
           run: npm run build

   publish:
      name: Publish to npm
      needs: test
      runs-on: ubuntu-latest
      permissions:
         contents: write
         id-token: write
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v6
           with:
              node-version: lts/*
              registry-url: https://registry.npmjs.org

         - name: Extract version from tag
           id: version
           run: |
              VERSION=${GITHUB_REF#refs/tags/v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Install dependencies
           run: npm ci

         - name: Update package versions
           run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version --workspaces --include-workspace-root

         - name: Build all packages
           run: npm run build

         - name: Publish @a1st/aix-schema
           run: npm publish --workspace @a1st/aix-schema --provenance --access public

         - name: Publish @a1st/aix-core
           run: npm publish --workspace @a1st/aix-core --provenance --access public

         - name: Publish @a1st/mcp-registry-client
           run: npm publish --workspace @a1st/mcp-registry-client --provenance --access public

         - name: Publish @a1st/aix
           run: npm publish --workspace @a1st/aix --provenance --access public

   create-release:
      name: Create GitHub Release
      needs: publish
      runs-on: ubuntu-latest
      permissions:
         contents: write
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Extract version from tag
           id: version
           run: |
              VERSION=${GITHUB_REF#refs/tags/v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Create GitHub Release
           uses: softprops/action-gh-release@v2
           with:
              tag_name: ${{ github.ref_name }}
              name: Release ${{ steps.version.outputs.version }}
              generate_release_notes: true
              draft: false
              prerelease: false
