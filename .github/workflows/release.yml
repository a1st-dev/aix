name: Release Packages

on:
   workflow_call:
      inputs:
         tag:
            description: Release tag (for example, v1.2.3)
            required: true
            type: string

jobs:
   publish:
      name: Publish to npm
      runs-on: ubuntu-latest
      permissions:
         contents: write
         id-token: write
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
           with:
              ref: refs/tags/${{ inputs.tag }}

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: lts/*
              registry-url: https://registry.npmjs.org

         - name: Extract version from tag
           id: version
           env:
              TAG: ${{ inputs.tag }}
           run: |
              VERSION=${TAG#v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Ensure npm supports trusted publishers
           run: npm install -g npm@latest

         - name: Install dependencies
           run: npm ci

         - name: Update package versions
           run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version --workspaces --include-workspace-root

          - name: Build all packages
            run: npm run build

          - name: Remove stale oclif manifest (CLI)
            run: rm -f packages/cli/oclif.manifest.json || true

          - name: Generate fresh oclif manifest (CLI)
            run: npm run --workspace @a1st/aix manifest

          - name: Verify manifest version matches package version (CLI)
            run: |
              PKG_VER=$(jq -r .version packages/cli/package.json)
              MAN_VER=$(jq -r .version packages/cli/oclif.manifest.json)
              echo "package.json version: $PKG_VER"
              echo "manifest version:     $MAN_VER"
              test "$PKG_VER" = "$MAN_VER"
              test "$PKG_VER" = "${{ steps.version.outputs.version }}"

          - name: Publish @a1st/aix-schema
            run: npm publish --workspace @a1st/aix-schema --provenance --access public

         - name: Publish @a1st/aix-core
           run: npm publish --workspace @a1st/aix-core --provenance --access public

         - name: Publish @a1st/mcp-registry-client
           run: npm publish --workspace @a1st/mcp-registry-client --provenance --access public

          - name: Publish @a1st/aix
            run: npm publish --workspace @a1st/aix --provenance --access public

   create-release:
      name: Create GitHub Release
      needs: publish
      runs-on: ubuntu-latest
      permissions:
         contents: write
      steps:
         - name: Extract version from tag
           id: version
           env:
              TAG: ${{ inputs.tag }}
           run: |
              VERSION=${TAG#v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Create GitHub Release
           uses: softprops/action-gh-release@v2
           with:
              tag_name: ${{ inputs.tag }}
              name: Release ${{ steps.version.outputs.version }}
              generate_release_notes: true
              draft: false
              prerelease: false
