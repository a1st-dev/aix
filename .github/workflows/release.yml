name: Release Packages

on:
   push:
      tags: ["v*"]

jobs:
   publish:
      name: Publish to npm
      runs-on: ubuntu-latest
      permissions:
         contents: write
         id-token: write
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: lts/*
              registry-url: https://registry.npmjs.org

         - name: Verify release tag is signed and GitHub-verified
           uses: actions/github-script@v7
           env:
              TAG: ${{ github.ref_name }}
           with:
              script: |
                 const tag = process.env.TAG;
                 const owner = context.repo.owner;
                 const repo = context.repo.repo;

                 const ref = await github.rest.git.getRef({
                   owner,
                   repo,
                   ref: `tags/${tag}`,
                 });

                 if (ref.data.object.type !== "tag") {
                   core.setFailed(
                     `Tag ${tag} is lightweight (${ref.data.object.type}). Release tags must be signed annotated tags.`
                   );
                   return;
                 }

                 const annotatedTag = await github.rest.git.getTag({
                   owner,
                   repo,
                   tag_sha: ref.data.object.sha,
                 });

                 const verification = annotatedTag.data.verification;
                 if (!verification?.verified) {
                   core.setFailed(
                     `Tag ${tag} is not GitHub-verified. Reason: ${verification?.reason ?? "unknown"}`
                   );
                   return;
                 }

                 core.info(`Tag ${tag} signature verified (${verification.reason}).`);

         - name: Extract version from tag
           id: version
           env:
              TAG: ${{ github.ref_name }}
           run: |
              VERSION=${TAG#v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Ensure npm supports trusted publishers
           run: npm install -g npm@latest

         - name: Install dependencies
           run: npm ci

         - name: Verify package versions already match release tag
           env:
              EXPECTED_VERSION: ${{ steps.version.outputs.version }}
           run: node ./scripts/verify-release-versions.mjs "$EXPECTED_VERSION"

         - name: Build all packages
           run: npm run build

         - name: Remove stale oclif manifest (CLI)
           run: rm -f packages/cli/oclif.manifest.json || true

         - name: Generate fresh oclif manifest (CLI)
           run: npm run --workspace @a1st/aix manifest

         - name: Verify manifest version matches package version (CLI)
           run: |
              PKG_VER=$(jq -r .version packages/cli/package.json)
              MAN_VER=$(jq -r .version packages/cli/oclif.manifest.json)
              echo "package.json version: $PKG_VER"
              echo "manifest version:     $MAN_VER"
              test "$PKG_VER" = "$MAN_VER"
              test "$PKG_VER" = "${{ steps.version.outputs.version }}"

         - name: Publish @a1st/aix-schema
           run: npm publish --workspace @a1st/aix-schema --provenance --access public

         - name: Publish @a1st/aix-core
           run: npm publish --workspace @a1st/aix-core --provenance --access public

         - name: Publish @a1st/mcp-registry-client
           run: npm publish --workspace @a1st/mcp-registry-client --provenance --access public

         - name: Publish @a1st/aix
           run: npm publish --workspace @a1st/aix --provenance --access public

   create-release:
      name: Create GitHub Release
      needs: publish
      runs-on: ubuntu-latest
      permissions:
         contents: write
      steps:
         - name: Extract version from tag
           id: version
           env:
              TAG: ${{ github.ref_name }}
           run: |
              VERSION=${TAG#v}
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Create GitHub Release
           uses: softprops/action-gh-release@v2
           with:
              tag_name: ${{ github.ref_name }}
              name: Release ${{ steps.version.outputs.version }}
              generate_release_notes: true
              draft: false
              prerelease: false
