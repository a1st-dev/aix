name: Test Suite

on:
   push:
      branches: [main]
   pull_request:
      branches: [main]

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

jobs:
   lint-and-typecheck:
      name: Lint & Type Check
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: lts/*
              cache: npm

         - name: Install dependencies
           run: npm ci

         - name: Run standards
           run: npm run standards

   test:
      name: Test (Node ${{ matrix.node }}, ${{ matrix.os }})
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest, windows-latest]
            node: [lts/*, 22]
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: ${{ matrix.node }}
              cache: npm

         - name: Install dependencies
           run: npm ci

         - name: Run tests
           run: npm test

   build:
      name: Build
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: lts/*
              cache: npm

         - name: Install dependencies
           run: npm ci

         - name: Build all packages
           run: npm run build

   all-tests-pass:
      name: All Tests Pass
      needs: [lint-and-typecheck, test, build]
      runs-on: ubuntu-latest
      steps:
         - name: Success
           run: echo "All tests passed successfully!"
